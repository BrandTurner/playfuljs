<html>
  <head>
    <title>Terrain Demo - PlayfulJS</title>
  </head>
  <body style='background: #000'>
    <canvas id='display' width='1' height='1' />

    <script>

      function Terrain(size) {
        this.size = size;
        this.map = new Uint8ClampedArray(size * size);
      }

      Terrain.prototype.get = function(x, y) {
        if (x < 0 || x >= this.size || y < 0 || y >= this.size) return -1;
        return this.map[x + this.size * y];
      };

      Terrain.prototype.set = function(x, y, val) {
        this.map[x + this.size * y] = val;
      };

      Terrain.prototype.average = function(list) {
        var values = list.filter(function(val) { return val !== -1; });
        var sum = values.reduce(function(total, val) { return total + val; }, 0);
        return sum / values.length;
      };

      Terrain.prototype.generate = function(base) {
        var self = this;

        // Initialize the corners
        this.set(0, 0, base);
        this.set(this.size - 1, 0, base);
        this.set(this.size - 1, this.size - 1, base);
        this.set(0, this.size - 1, base);

        divide((this.size - 1) / 2);

        function divide(step) {
          if (step < 1) return;

          var x, y;

          for (y = step; y < self.size; y += step) {
            for (x = step; x < self.size; x += step) {
              square(x, y, step);           // center
            }
          }
          for (y = step; y < self.size; y += step) {
            for (x = step; x < self.size; x += step) {
              diamond(x, y - step, step);   // top
              diamond(x + step, y, step);   // right
              diamond(x, y + step, step);   // bottom
              diamond(x - step, y, step);   // left
            }
          }
          divide(step / 2);
        }

        function square(x, y, size) {
          var average = self.average([
            self.get(x - size, y - size),
            self.get(x - size, y - size),
            self.get(x + size, y - size),
            self.get(x + size, y + size)
          ]);
          self.set(x, y, average);
        }

        function diamond(x, y, size) {
          var average = self.average([
            self.get(x, y - size),
            self.get(x + size, y),
            self.get(x, y + size),
            self.get(x - size, y)
          ]);
          self.set(x, y, average);
        }
      };

      var terrain = new Terrain(5);

      terrain.generate(128);

      console.log(terrain.map);

    </script>
  </body>
</html>
