<html>
  <head>
    <title>Terrain Demo - PlayfulJS</title>
  </head>
  <body style='background: #000'>
    <canvas id='display' width='1' height='1' />

    <script>

      function Terrain(size) {
        this.size = size;
        this.max = size - 1;
        this.map = new Float32Array(size * size);
      }

      Terrain.prototype.get = function(x, y) {
        if (x < 0 || x > this.max || y < 0 || y > this.max) return 128;
        return this.map[x + this.size * y];
      };

      Terrain.prototype.set = function(x, y, val) {
        this.map[x + this.size * y] = val;
      };

      Terrain.prototype.generate = function(roughness) {
        var self = this;
        var scale = roughness * 128;

        // Initialize the corners
        this.set(0, 0, 128);
        this.set(this.max, 0, 128);
        this.set(this.max, this.max, 128);
        this.set(0, this.max, 128);

        divide(this.max);

        function divide(size) {
          var half = size / 2;
          if (half < 1) return;

          scale *= 0.5;

          grid(size, function(x, y) {
            square(x + half, y + half, half);    // center
          });

          grid(size, function(x, y) {
            diamond(x + half, y, half);          // top
            diamond(x + size, y + half, half);   // right
            diamond(x + half, y + size, half);   // bottom
            diamond(x, y + half, half);          // left
          });

          divide(half);
        }

        function grid(size, fn) {
          for (var y = 0; y < self.max; y += size) {
            for (var x = 0; x < self.max; x += size) {
              fn(x, y);
            }
          }
        }

        function square(x, y, size) {
          var average = (
            self.get(x - size, y - size) +   // upper left
            self.get(x + size, y - size) +   // upper right
            self.get(x + size, y + size) +   // lower right
            self.get(x - size, y + size)    // lower left
          ) / 4;
          self.set(x, y, average + Math.random() * scale * 2 - scale);
        }

        function diamond(x, y, size) {
          var average = (
            self.get(x, y - size) +     // top
            self.get(x + size, y) +     // right
            self.get(x, y + size) +     // bottom
            self.get(x - size, y)       // left
          ) / 4;
          self.set(x, y, average + Math.random() * scale * 2 - scale);
        }
      };

      Terrain.prototype.draw = function() {
        var self = this;
        var point, x, y;
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
        ctx.lineWidth = 1;
        for (x = 0; x < this.size; x++) {
          point = project(x, 0, this.get(x, 0));
          ctx.beginPath();
          ctx.moveTo(point.x, point.y);
          for (y = 1; y < this.size; y++) {
            point = project(x, y, this.get(x, y));
            ctx.lineTo(point.x, point.y);
          }
          ctx.stroke();
        }
        for (y = 0; y < this.size; y++) {
          point = project(0, y, this.get(0, y));
          ctx.beginPath();
          ctx.moveTo(point.x, point.y);
          for (x = 1; x < this.size; x++) {
            point = project(x, y, this.get(x, y));
            ctx.lineTo(point.x, point.y);
          }
          ctx.stroke();
        }
        function project(x, y, z) {
          var xScale = width / self.size * 0.8;
          var yScale = height / self.size * 0.8;
          var peak = (128 - z);
          return {
            x: (x * 0.5 + y * 0.5) * xScale,
            y: height * 0.5 + (-x * 0.5 + y * 0.5 + peak) * yScale
          };
        }
      };

      var terrain = new Terrain(129);
      var display = document.getElementById('display');
      var ctx = display.getContext('2d');
      var drops = [];
      var width = display.width = window.innerWidth;
      var height = display.height = window.innerHeight;

      ctx.globalCompositeOperation = 'overlay';
      terrain.generate(0.5);
      terrain.draw();

    </script>
  </body>
</html>
